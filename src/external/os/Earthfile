# Copyright 2024 Ekumen, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

VERSION 0.8

ubuntu:
    ARG distro
    FROM ubuntu:${distro}
    ENV PIP_ROOT_USER_ACTION=ignore
    ENV PIP_BREAK_SYSTEM_PACKAGES=1
    RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y \
        bash coreutils curl git keyboard-configuration locales \
        python3 python3-pip python3-dev tzdata sudo lsb-release \
        && apt clean && rm -rf /var/lib/apt/lists/*
    RUN locale-gen en_US.UTF-8
    ARG TARGETOS
    ARG TARGETARCH
    RUN curl -sSL "https://github.com/mikefarah/yq/releases/latest/download/yq_${TARGETOS}_${TARGETARCH}" \
        -o /usr/local/bin/yq && chmod +x /usr/local/bin/yq
    ENTRYPOINT ["/bin/bash", "--login"]

ADDUSER:
    FUNCTION
    ARG user
    ARG uid
    ARG gid
    RUN addgroup --gid ${gid} ${user} && \
        adduser --uid ${uid} --ingroup ${user} \
        --home /home/${user} --shell /bin/bash ${user} && \
        echo "${user}:${user}" | chpasswd && adduser ${user} sudo && \
        echo "${user} ALL=NOPASSWD: ALL" >> /etc/sudoers.d/${user}
    USER ${user}
    ENV HOME=/home/${user}
    WORKDIR /home/${user}
